name: vagrant-up
on: 
  workflow_call: # This allows the workflow to be called from other workflows
  push: # Keep this to also allow direct triggering

jobs:
  vagrant-up:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Install Vagrant
      run: |
        wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
        sudo apt-get update && sudo apt-get install -y vagrant
    
    - name: Install VirtualBox
      run: sudo apt-get install -y virtualbox
      
    - name: Install Ansible
      run: sudo apt-get install -y ansible
      
    - name: Cache Vagrant boxes
      uses: actions/cache@v3
      with:
        path: ~/.vagrant.d/boxes
        key: ${{ runner.os }}-vagrant-${{ hashFiles('Vagrantfile') }}
        restore-keys: |
          ${{ runner.os }}-vagrant-
    
    - name: Show Vagrant version
      run: vagrant --version
    
    - name: Run vagrant up
      run: vagrant up
    
    - name: SSH into nodes
      run: |
        if grep -q "k8s-master" Vagrantfile; then
          # For Kubernetes cluster
          vagrant ssh k8s-master -c "echo 'Kubernetes master node is up!'"
          vagrant ssh node-1 -c "echo 'Kubernetes worker node 1 is up!'" || true
          vagrant ssh node-2 -c "echo 'Kubernetes worker node 2 is up!'" || true
        else
          # Default behavior
          vagrant ssh -c "echo 'hello world!'"
        fi
